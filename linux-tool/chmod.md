# chmod

## 简介

更改指定文件的访问权限，默认忽略所有符号链接，如果需要变更符号链接的权限，请修改符号链接最终指向真实文件的权限

```
chmod [option]… {mode | --reference=ref_file} file…
```

```
[ugoa]*([-+=]([rwxXst]*|[ugo]))+|[-+=][0-7]+
```

## 选项

<style>
table th:first-of-type {
    width: 16%;
}
</style>

| 选项                  | 说明                                                                                                                                                                                                                           |
| :-------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -c, --changes         | 详细描述权限实际上发生变化的每个文件的操作                                                                                                                                                                                     |
| -f, --silent, --quiet | 不要打印有关其权限无法更改的文件的错误消息                                                                                                                                                                                     |
| -v, --verbose         | 详细描述对每个文件采取的措施或不采取的措施                                                                                                                                                                                     |
| --reference=ref_file  | 将每个文件的权限更改为与`ref_file`文件相同。请参阅[文件权限](https://www.gnu.org/software/coreutils/manual/html_node/File-permissions.html#File-permissions)。如果`ref_file`是符号链接，则使用它所引用（指向的最终）文件的权限 |
| -R, --recursive       | 递归更改目录及其所有子目录和文件的权限                                                                                                                                                                                         |
| --preserve-root       | 尝试递归更改根目录`/`时直接失败。如果没有`--recursive`，则此选项无效。[参考阅读](https://www.gnu.org/software/coreutils/manual/html_node/Treating-_002f-specially.html#Treating-_002f-specially)                               |
| --no-preserve-root    | 取消任何前面的`--preserve-root`选项的影响                                                                                                                                                                                      |
| --help                | 显示此帮助信息并退出                                                                                                                                                                                                           |
| --version             | 显示版本信息并退出                                                                                                                                                                                                             |

## Linux 权限和设置

在使用 chmod 命令前，还需要先了解 Linux 系统的权限是如何表示的。首先是权限分为三种：读取、写入、执行，分别以 8 进制数表
示如下

- 读取（`r`）八进制为`4`，二进制为`1 0 0`
- 写入（`w`）八进制为`2`，二进制为`0 1 0`
- 执行（`x`）八进制为`1`，二进制为`0 0 1`

Linux 中的文件有三个不同层级的权限，分别是用户、用户组、其它用户，表示如下

权限表示：`-rwx-rwx-rwx` 二进制表示：`1 1 1 1 1 1 1 1 1` 从左向右：

- 第一个`rwx`表示用户的读写权限设置
- 第二个`rwx`表示用户组的读写权限设置
- 第三个`rwx`表示其它用户的读写权限设置

在使用 chmod 命令时，每个层级的权限是仅仅用一个 8 进制数来表示的，它是三个权限的八进制数相加的和，表示如下

- 只拥有读取权限：八进制为`4+0+0=4`，权限表示为`-r--`，二进制为`1 0 0`
- 只拥有写入权限：八进制为`0+2+0=2`，权限表示为`--w-`，二进制为`0 1 0`
- 只拥有执行权限：八进制为`0+0+1=1`，权限表示为`---x`，二进制为`0 0 1`
- 拥有读取和写入：八进制为`4+2+0=6`，权限表示为`-rw-`，二进制为`1 1 0`
- 拥有读取和执行：八进制为`4+0+1=5`，权限表示为`-r-x`，二进制为`1 0 1`
- 拥有写入和执行：八进制为`0+2+1=3`，权限表示为`--wx`，二进制为`0 1 1`
- 读取写入和执行：八进制为`4+2+1=7`，权限表示为`-rwx`，二进制为`1 1 1`

接下来分析一个赋予权限的 chmod 命令

```bash
chmod 752 /opt/test.sh
```

首先拆解数字命令为三个，第一个`7`表示用户权限，`7=4+2+1`，即表示用户可以读取写入和执行这个文件；第二个`5`表示用户组权限
，`5=4+0+1`，即用户组内的用户可以读取和执行这个文件；第三个`2`表示其它用户权限，`2=0+2+1`，即其它用户可以写入这个文件，
这个权限以二进制的方式表示出来就是

```
-rwxr-x-w- = 1 1 1  1 0 1  0 1 0 = 752
```

## 附加权限

Linux 除了设置正常的读写操作权限外，还有关于一类设置也是涉及到权限，叫做 Linux 附加权限。包括 SET 位权限（suid，sgid）和
粘滞位权限（sticky）。

SET 位权限： suid/sgid 是为了使“没有取得特权用户要完成一项必须要有特权才可以执行的任务”而产生的。 一般用于给可执行的程序
或脚本文件进行设置，其中 SUID 表示对属主用户增加 SET 位权限，SGID 表示对属组内用户增加 SET 位权限。执行文件被设置了
SUID、SGID 权限后，任何用户执行该文件时，将获得该文件属主、属组账号对应的身份。在许多环境中，suid 和 sgid 很管用，但是不
恰当地使用这些位可能使系统的安全遭到破坏。所以应该尽量避免使用 SET 位权限程序。（passwd 命令是为数不多的必须使用“suid”的
命令之一）。

suid(set User ID,set UID)的意思是进程执行一个文件时通常保持进程拥有者的 UID。然而，如果设置了可执行文件的 suid 位，进程
就获得了该文件拥有者的 UID。

sgid(set Group ID,set GID)意思也是一样，只是把上面的进程拥有者改成进程组就好了。

SET 位权限表示形式（10 位权限）：

如果一个文件被设置了`suid`或`sgid`位，会分别表现在所有者或同组用户的权限的可执行位上；如果文件设置了`suid`还设置了`x`（
执行）位，则相应的执行位表示为`s`(小写)。但是，如果没有设置`x`位，它将表示为`S`(大写)。如：

- `-rwsr-xr-x`表示设置了 suid，且拥有者有可执行权限
- `-rwSr--r--`表示 suid 被设置，但拥有者没有可执行权限
- `-rwxr-sr-x`表示 sgid 被设置，且群组用户有可执行权限
- `-rw-r-Sr--`表示 sgid 被设置，但群组用户没有可执行权限

SET 位权限可以通过`chmod`命令设置，给文件加`suid`和`sgid`的命令如下(类似于上面`chmod`赋予一般权限的命令)

- `chmod u+s filename`设置 suid 位
- `chmod u-s filename`去掉 suid 设置
- `chmod g+s filename`设置 sgid 位
- `chmod g-s filename`去掉 sgid 设置

粘滞位权限：

粘滞位权限即`sticky`。一般用于为目录设置特殊的附加权限，当目录被设置了粘滞位权限后，即便用户对该目录有写的权限，也不能删
除该目录中其他用户的文件数据。设置了粘滞位权限的目录，是用`ls -l`查看其属性时，其他用户权限处的`x`将变为`t`。使
用`chmod`命令设置目录权限时，`+t`、`-t`权限模式可分别用于添加、移除粘滞位权限

粘滞位权限表示形式（10 位权限）：

一个文件或目录被设置了粘滞位权限，会表现在其他用户的权限的可执行位上。如果文件设置了`sticky`还设置了`x`（执行）位，其他
组用户的权限的可执行位为`t`（小写）。但是，如果没有设置`x`位，它将表示为`T`（大写）

- `-rwsr-xr-t`表示设置了粘滞位且其他用户有可执行权限
- `-rwSr--r-T`表示设置了粘滞位但其他用户没有可执行权限

`sticky`权限同样可以通过`chmod`命令设置

- `chmod +t filename`设置`sticky`
- `chmod -t filename`去掉`sticky`设置

## 符号表示权限

```
[ugoa...][-+=]perms...[,...]
```

- `u`表示该文件的拥有者，`g`表示与该文件的拥有者属于同一个群体（group）者，`o`表示其他以外的人，`a`表示这三者皆有
- `+`表示增加权限、`-`表示取消权限、`=`表示唯一设定权限
- `r`表示可读取，`w`表示可写入，`x`表示可执行，`X`表示只有当该文件是个子目录或者该文件已经被设定过为可执行

例子

- `chmod u+x,g-w,a+r file`表示为用户加上可执行权限，用户组去掉执行权限，所有的都加上读取权限
- `chmod og-x,u+wx file`表示为用户加上写入和执行，用户组和其它用户去掉执行权限
- `chmod u+s,g-s file`表示为用户加上`SUID`权限，用户组去掉`SGID`权限

## 八进制数表示权限

八进制数分为三位数表示和四位数表示，从左往右

- 三位数是表示用户、用户组和其它用户，如`644`
- 四位数是表示特殊权限、用户、用户组和其它用户，如`6644`

三位数的表示也可以使用`+`和`-`，如

- `chmod +110 file`表示为用户和用户组增加执行权限
- `chmod -003 file`表示去掉其它用户的写入和执行权限

不使用`+`或`-`则是直接重新设置其权限

SET 分别表示`SUID`权限、`SGID`权限、和`sticky`权限，这十二位（二进制）分别对应关系如下：

第 11 位为`SUID`位，第 10 位为`SGID`位，第 9 位为`sticky`位，第 8 到 0 位对应于用户、用户组和其它用户的三组`rwx`位（后九
位）

- `-rw-r-sr--` 的值为：`0 1 0 1 1 0 1 0 0 1 0 0`
- `-rwsr-xr-x` 的值为：`1 0 0 1 1 1 1 0 1 1 0 1`
- `-rwsr-sr-x` 的值为：`1 1 0 1 1 1 1 0 1 1 0 1`
- `-rwsr-sr-t` 的值为：`1 1 1 1 1 1 1 0 1 1 0 1`

例子

- `chmod +4001 file`表示为用户添加`SUID`权限，其它用户添加执行权限
- `chmod -2011 file`表示为用户组去掉`SGID`权限，用户组和其它用户去掉执行权限

Last Modified 2021-04-11
