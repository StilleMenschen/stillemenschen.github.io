# tcpdump

## 简介

`tcpdump` 是一个命令行数据包分析工具，用于抓取和显示经过网络接口的数据包。它常用于网络故障排查、安全分析和流量监控。

```
tcpdump [options] [expression]
```

## 命令

使用 `tcpdump` 抓包时，通常需要以 root 权限执行。命令模式可以通过指定不同的选项和过滤表达式进行配置。

<style>
table th:first-of-type {
    width: 20%;
}
</style>

## 选项

| 选项          | 说明                                                         |
| :------------ | :----------------------------------------------------------- |
| -h            | 显示帮助信息                                                 |
| -i interface  | 指定要监听的网络接口，默认是第一个活跃的接口                 |
| -c count      | 抓取指定数量的包后退出                                       |
| -r file       | 从指定的文件读取数据包而不是实时监听                         |
| -W file       | 将抓取的数据包写入指定文件                                   |
| -w file       | 将抓到的数据包保存到指定文件                                 |
| -n            | 不解析主机名，直接显示 IP 地址                               |
| -p            | 不进入混杂模式，只有目标网卡的数据包会被捕获                 |
| -s snaplen    | 设置抓取的数据包的最大长度 (snap length)，默认长度为 68 字节 |
| -v, -vv, -vvv | 显示详细程度，增加 v 的数量会提供更详细的信息                |
| -A            | 以 ASCII 形式打印数据包内容                                  |
| -X            | 显示数据包的十六进制和 ASCII 表示                            |
| -F file       | 使用指定的过滤表达式文件                                     |

## 过滤表达式

`tcpdump` 的过滤表达式用于限制捕获的数据包，使用户能够专注于特定的通信。过滤器的语法灵活，允许使用各种组合的条件。以下是一些常见的过滤表达式及其用法：

### 基本过滤器

- 主机过滤：

  - `host [IP 地址]`：捕获与指定 IP 地址的所有通信。
    - 示例：`tcpdump host 192.168.1.1`

- 源和目标主机：

  - `src host [IP 地址]`：捕获源 IP 地址为指定地址的数据包。
    - 示例：`tcpdump src host 192.168.1.1`
  - `dst host [IP 地址]`：捕获目标 IP 地址为指定地址的数据包。
    - 示例：`tcpdump dst host 192.168.1.1`

- 协议过滤：
  - `tcp`：仅捕获 TCP 数据包。
  - `udp`：仅捕获 UDP 数据包。
  - `icmp`：仅捕获 ICMP 数据包。

### 端口过滤

- 指定端口：

  - `port [端口号]`：捕获目标或源端口为指定端口的数据包。
    - 示例：`tcpdump port 80`（捕获 HTTP 流量）

- 源或目标端口：
  - `src port [端口号]`：捕获源端口为指定端口的数据包。
    - 示例：`tcpdump src port 80`
  - `dst port [端口号]`：捕获目标端口为指定端口的数据包。
    - 示例：`tcpdump dst port 22`（捕获针对 SSH 的数据包）

### 组合过滤

- 逻辑操作：
  可以使用逻辑运算符 `and`, `or`, 和 `not` 来组合多个过滤条件。
  - 示例：`tcpdump tcp and port 80`（捕获所有 TCP 的 HTTP 流量）
  - 示例：`tcpdump src host 192.168.1.1 and not dst port 53`（捕获来自 192.168.1.1 的非 DNS 流量）

### 用户自定义的复杂过滤

- 网络段过滤：

  - 使用 CIDR 语法来捕获特定网络范围内的数据包。
    - 示例：`tcpdump net 192.168.1.0/24`

- 特定的协议和端口组合：
  - 示例：`tcpdump tcp port 443 or udp port 53`（捕获 HTTPs 和 DNS 流量）

### 其他过滤选项

- 捕获特定长度的数据包：

  - `len <= [长度]`：仅捕获长度小于或等于指定长度的数据包。
    - 示例：`tcpdump 'len <= 100'`（捕获小于等于 100 字节的数据包）

- 输出数据包内容：
  使用 `-A` 或 `-X` 标志配合过滤表达式，可以输出数据包的实际内容。
  - 示例：`tcpdump -A 'tcp port 80'`（以 ASCII 格式输出 HTTP 流量的内容）

通过合理使用和组合以上过滤表达式，您可以精确捕获所需的网络流量，这对于网络监控和故障排查极为重要。

## 示例

1. 捕获所有从和到本地主机的 TCP 流量

   ```bash
   tcpdump -i any tcp
   ```

2. 捕获并保存指定接口的前 100 个数据包到文件

   ```bash
   tcpdump -i eth0 -c 100 -w capture.pcap
   ```

3. 从文件读取数据包并以可读格式输出

   ```bash
   tcpdump -r capture.pcap
   ```

4. 捕获指定端口的 HTTP 流量，并以 ASCII 输出包内容

   ```bash
   tcpdump -A -i eth0 port 80
   ```

5. 捕获特定 IP 地址的数据包

   ```bash
   tcpdump -i eth0 host 192.168.1.100
   ```

Last Modified 2024-12-06
