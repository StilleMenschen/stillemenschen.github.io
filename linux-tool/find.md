# find

## 简介

find命令可以根据给定的路径和表达式查找文件或目录。find参数选项很多，并且支持正则，功能强大。

find如不加任何参数，表示查找当前路径下的所有文件和目录，如果服务器负载比较高尽量不要在高峰期使用find命令，find命令模糊搜索还是比较消耗系统资源的。表达式包含测试和动作。

```
find [-H] [-L] [-P] [path...] [expression]
```
## 选项

选项必须写在路径和表达式的前面

选项 | 说明
:--- | :---
-P | 不跟随符号链接查找，展示符号链接本身的信息
-L | 跟随符号链接查找，从符号链接指向的真实文件获取信息。如果符号链接指向的是目录，则find会继续搜索符号链接指向的目录。
-H | 除命令行指定的路径为符号链接之外，不跟随符号链接查找

>当 -L 选项生效时，-type表达式始终与符号链接指向的文件类型匹配，并且 -lname 和 -ilname 表达式会始终返回false

## 测试

测试表达式中的数字有三种写法，下面的表达式中都假设n为数字，+n表示查找大于该数字的，-n表示查找小于该数字的，n表示查找刚好等于该数字的

Linux中文件的权限分为读、写、执行，表示方式有两种分别是八进制和符号

1. 八进制，三位数字

数字6表示可读写，数字5表示可读和执行，数字3表示可写和执行，具体可去查询Linux的权限是怎么表示

  * 第一位表示用户权限
  * 第二位表示用户组权限
  * 第三位表示其他用户的权限

> 比如`755`表示用户可以读写和执行，但用户组内用户和其他用户仅可以读和执行

2. 符号，键值对

可能的值为`r`、`w`、`x`，分别表示读、写、执行

  * u表示用户权限
  * g表示用户组权限
  * o表示其他用户权限

> 比如`u=rwx,g=rx,o=rx`表示用户可以读写和执行，但用户组内用户和其他用户仅可以读和执行

表达式 | 说明
:--- | :---
-maxdepth levels | 指定最大搜索目录层级，levels为非负整数，如指定为2，则从指定目录查找目录树中最大到2级的所有文件
-mindepth levels | 指定最小开始搜索目录层级，levels为非负整数，如指定为2，则从指定目录查找目录树中2级目录开始，层级大于2级的所有文件
-amin n          | 上次访问文件在n分钟之前
-atime n         | 文件的访问时间为n*24小时
-cmin n          | 文件的状态在n分钟前上次更改。
-ctime n         | 文件状态的修改时间为n*24小时
-empty           | 匹配空文件，可以是常规文件或目录
-gid             | 匹配文件的用户组数字ID
-group           | 匹配文件的用户组名（数字组ID也可）
-lname           | 匹配符号链接名，支持通配符`*`，但表达式必须使用引号包裹，如`'*a*.py'`
-ilname          | 和`-lname`类似，但忽略大小写
-regex           | 使用正则表达式匹配文件名，使用`-regextype`可以指定匹配类型
-iregex          | 和`-regex`类似，但忽略大小写
-regextype type  | 修改正则表达式匹配类型，默认类型是emacs，支持posix-awk，posix-basic，posix-egrep和posix-extended
-name            | 匹配文件名，支持通配符`*`，但表达式必须使用引号包裹，如`'*a*.py'`
-iname           | 和`-name`类似，但忽略大小写
-mmin n          | 文件的数据最后一次修改是在n分钟前
-mtime n         | 文件数据的最后修改时间为n*24小时
-nogroup         | 没有任何组对应于文件的数字组ID
-nouser          | 没有用户对应于文件的数字用户ID
-path            | 匹配路径，不处理元字符`/`和`.`。如使用`'./sr*sc'`可以搜索到`./src/misc`
-ipath           | 和`-path`类似，但忽略大小写
-perm mode       | 文件的权限完全与mode匹配（权限用八进制或符号表示），如`-perm u=rw,g=r`或`-perm 640`或`-perm u+rw,g+r`
-perm -mode      | 文件权限必须包含有mode中指定的权限，如`-perm -u=rw,g=r`或`-perm -640`或`-perm -u+rw,g+r`
-perm /mode      | 文件权限包含有mode中指定的权限，但不考虑其它的权限是否包含，如`-perm /u=rw,g=r`或`-perm /640`或`-perm /u+rw,g+r`
-readable        | 匹配可读取的文件
-size n[cwbkMG]  | 匹配文件大小，b(块，512字节)、c(字节)、w(双字节字符)、k(1024个字节)、M(1048576个字节)、G(1073741824个字节)
-type c          | 匹配文件类型，b(块设备，缓冲区)、c(字符，无缓冲区)、d(目录)、p(命名管道)、f(常规文件)、l(符号链接)、s(套接字)
-uid             | 匹配文件的用户数字ID
-user            | 匹配文件的用户名（数字ID也可）
-writable        | 匹配可写文件

## 动作

放在所有测试选项的最后面，对查找到的文件执行指定动作

表达式 | 说明
:--- | :---
-exec command ; | 对所有查询到的文件执行命令，类似于`xargs`命令，可以使用`{}`替代表示匹配到的文件名，末尾的`;`需要使用`\`转义
-ok command ;   | 类似`-exec`，但会先询问用户是否执行`command`
-ls             | 在标准输出上以`ls -dils`格式列出当前文件。除非设置了环境变量POSIXLY_CORRECT，否则块计数为1K块，在这种情况下，将使用512字节的块
-prune          | 忽略前面的匹配项

## 操作符

使用操作符可以进行更复杂的判断查找

操作符 | 说明
:--- | :---
( 表达式 )          | 强制优先判断括号内的表达式，可能需要使用转义：`\(...\)`表示`(...)`
! 表达式            | 取反，如果表达式为`true`则会变成`false`
-not 表达式         | 类似`!`, 但不符合POSIX规范
表达式1 表达式2      | 表示并且`and`
表达式1 -a 表达式2   | 类似`表达式1 表达式2`
表达式1 -and 表达式2 | 类似`表达式1 表达式2`，但不符合POSIX规范
表达式1 -o 表达式2   | 表示或者`or`
表达式1 -or 表达式2  | 类似`表达式1 -o 表达式2`，但不符合POSIX规范
表达式1 , 表达式2    | 顺序匹配，如果表达式1为`true`则表达式2不会执行，若表达式1为`false`则执行表达式2

## 命令示例

1. 查找当前所在目录下30分钟内有修改且大小小于10M的文件并列出文件信息

    ```bash
    find . -mmin -30 -size -10M -ls
    ```

2. 查找用户主目录下一级和二级目录中名称以`a`开头且不为空的文件或目录并列出文件信息

    ```bash
    find $HOME -maxdepth 2 -iname 'a*' ! -empty -ls
    ```

3. 查找`/opt`目录下以`test`开头或以`admin`结尾的目录并计算目录大小

    ```bash
    find /opt -type d \( -name 'test*' -o -name '*admin' \) -exec du -hd 0 {} \;
    ```

4. 查找`/var/logs`目录中7天前大于30M的log文件并删除

    ```bash
    find /var/logs -name '*.log' -mtime +7 -size +30M -exec rm -f {} \;
    ```

Last Modified 2021-03-28