# find

## 简介

find 命令可以根据给定的路径和表达式查找文件或目录。find 选项很多，并且支持正则，功能强大。

find 如不加任何选项，表示查找当前路径下的所有文件和目录，如果服务器负载比较高尽量不要在高峰期使用 find 命令，find 命令模
糊搜索还是比较消耗系统资源的。表达式包含测试和动作。

```
find [-H] [-L] [-P] [path...] [expression]
```

## 选项

<style>
table th:first-of-type {
    width: 20%;
}
</style>

选项必须写在路径和表达式的前面

| 选项 | 说明                                                                                                                 |
| :--- | :------------------------------------------------------------------------------------------------------------------- |
| -P   | 不跟随符号链接查找，展示符号链接本身的信息                                                                           |
| -L   | 跟随符号链接查找，从符号链接指向的真实文件获取信息。如果符号链接指向的是目录，则 find 会继续搜索符号链接指向的目录。 |
| -H   | 除命令行指定的路径为符号链接之外，不跟随符号链接查找                                                                 |

>当 -L 选项生效时，-type 表达式始终与符号链接指向的文件类型匹配，并且 -lname 和 -ilname 表达式会始终返回 false

## 测试

测试表达式中的数字有三种写法，下面的表达式中都假设 n 为数字，+n 表示查找大于该数字的，-n 表示查找小于该数字的，n 表示查
找刚好等于该数字的

Linux 中文件的权限分为读、写、执行，表示方式有两种分别是八进制和符号

1. 八进制，三位数字

数字 6 表示可读写，数字 5 表示可读和执行，数字 3 表示可写和执行，具体可去查询 Linux 的权限是怎么表示

- 第一位表示用户权限
- 第二位表示用户组权限
- 第三位表示其他用户的权限

>比如`755`表示用户可以读写和执行，但用户组内用户和其他用户仅可以读和执行

2. 符号，键值对

可能的值为`r`、`w`、`x`，分别表示读、写、执行

- u 表示用户权限
- g 表示用户组权限
- o 表示其他用户权限

>比如`u=rwx,g=rx,o=rx`表示用户可以读写和执行，但用户组内用户和其他用户仅可以读和执行

| 表达式           | 说明                                                                                                                    |
| :--------------- | :---------------------------------------------------------------------------------------------------------------------- |
| -maxdepth levels | 指定最大搜索目录层级，levels 为非负整数，如指定为 2，则从指定目录查找目录树中最大到 2 级的所有文件                      |
| -mindepth levels | 指定最小开始搜索目录层级，levels 为非负整数，如指定为 2，则从指定目录查找目录树中 2 级目录开始，层级大于 2 级的所有文件 |
| -amin n          | 上次访问文件在 n 分钟之前                                                                                               |
| -atime n         | 文件的访问时间为 n\*24 小时                                                                                             |
| -cmin n          | 文件的状态在 n 分钟前上次更改。                                                                                         |
| -ctime n         | 文件状态的修改时间为 n\*24 小时                                                                                         |
| -empty           | 匹配空文件，可以是常规文件或目录                                                                                        |
| -gid             | 匹配文件的用户组数字 ID                                                                                                 |
| -group           | 匹配文件的用户组名（数字组 ID 也可）                                                                                    |
| -lname           | 匹配符号链接名，支持通配符`*`，但表达式必须使用引号包裹，如`'*a*.py'`                                                   |
| -ilname          | 和`-lname`类似，但忽略大小写                                                                                            |
| -regex           | 使用正则表达式匹配文件名，使用`-regextype`可以指定匹配类型                                                              |
| -iregex          | 和`-regex`类似，但忽略大小写                                                                                            |
| -regextype type  | 修改正则表达式匹配类型，默认类型是 emacs，支持 posix-awk，posix-basic，posix-egrep 和 posix-extended                    |
| -name            | 匹配文件名，支持通配符`*`，但表达式必须使用引号包裹，如`'*a*.py'`                                                       |
| -iname           | 和`-name`类似，但忽略大小写                                                                                             |
| -mmin n          | 文件的数据最后一次修改是在 n 分钟前                                                                                     |
| -mtime n         | 文件数据的最后修改时间为 n\*24 小时                                                                                     |
| -nogroup         | 没有任何组对应于文件的数字组 ID                                                                                         |
| -nouser          | 没有用户对应于文件的数字用户 ID                                                                                         |
| -path            | 匹配路径，不处理元字符`/`和`.`。如使用`'./sr*sc'`可以搜索到`./src/misc`                                                 |
| -ipath           | 和`-path`类似，但忽略大小写                                                                                             |
| -perm mode       | 文件的权限完全与 mode 匹配（权限用八进制或符号表示），如`-perm u=rw,g=r`或`-perm 640`或`-perm u+rw,g+r`                 |
| -perm -mode      | 文件权限必须包含有 mode 中指定的权限，如`-perm -u=rw,g=r`或`-perm -640`或`-perm -u+rw,g+r`                              |
| -perm /mode      | 文件权限包含有 mode 中指定的权限，但不考虑其它的权限是否包含，如`-perm /u=rw,g=r`或`-perm /640`或`-perm /u+rw,g+r`      |
| -readable        | 匹配可读取的文件                                                                                                        |
| -size n[cwbkMG]  | 匹配文件大小，b(块，512 字节)、c(字节)、w(双字节字符)、k(1024 个字节)、M(1048576 个字节)、G(1073741824 个字节)          |
| -type c          | 匹配文件类型，b(块设备，缓冲区)、c(字符，无缓冲区)、d(目录)、p(命名管道)、f(常规文件)、l(符号链接)、s(套接字)           |
| -uid             | 匹配文件的用户数字 ID                                                                                                   |
| -user            | 匹配文件的用户名（数字 ID 也可）                                                                                        |
| -writable        | 匹配可写文件                                                                                                            |

## 动作

放在所有测试选项的最后面，对查找到的文件执行指定动作

| 表达式          | 说明                                                                                                                                |
| :-------------- | :---------------------------------------------------------------------------------------------------------------------------------- |
| -exec command ; | 对所有查询到的文件执行命令，类似于`xargs`命令，可以使用`{}`替代表示匹配到的文件名，末尾的`;`需要使用`\`转义                         |
| -ok command ;   | 类似`-exec`，但会先询问用户是否执行`command`                                                                                        |
| -ls             | 在标准输出上以`ls -dils`格式列出当前文件。除非设置了环境变量 POSIXLY_CORRECT，否则块计数为 1K 块，在这种情况下，将使用 512 字节的块 |
| -prune          | 忽略前面的匹配项                                                                                                                    |

## 操作符

使用操作符可以进行更复杂的判断查找

| 操作符                 | 说明                                                                                   |
| :--------------------- | :------------------------------------------------------------------------------------- |
| ( 表达式 )             | 强制优先判断括号内的表达式，可能需要使用转义：`\(...\)`表示`(...)`                     |
| ! 表达式               | 取反，如果表达式为`true`则会变成`false`                                                |
| -not 表达式            | 类似`!`, 但不符合 POSIX 规范                                                           |
| 表达式 1 表达式 2      | 表示并且`and`                                                                          |
| 表达式 1 -a 表达式 2   | 类似`表达式1 表达式2`                                                                  |
| 表达式 1 -and 表达式 2 | 类似`表达式1 表达式2`，但不符合 POSIX 规范                                             |
| 表达式 1 -o 表达式 2   | 表示或者`or`                                                                           |
| 表达式 1 -or 表达式 2  | 类似`表达式1 -o 表达式2`，但不符合 POSIX 规范                                          |
| 表达式 1 , 表达式 2    | 顺序匹配，如果表达式 1 为`true`则表达式 2 不会执行，若表达式 1 为`false`则执行表达式 2 |

## 命令示例

1. 查找当前所在目录下 30 分钟内有修改且大小小于 10M 的文件并列出文件信息

   ```bash
   find . -mmin -30 -size -10M -ls
   ```

2. 查找用户主目录下一级和二级目录中名称以`a`开头且不为空的文件或目录并列出文件信息

   ```bash
   find $HOME -maxdepth 2 -iname 'a*' ! -empty -ls
   ```

3. 查找`/opt`目录下以`test`开头或以`admin`结尾的目录并计算目录大小

   ```bash
   find /opt -type d \( -name 'test*' -o -name '*admin' \) -exec du -hd 0 {} \;
   ```

4. 查找`/var/logs`目录中 7 天前大于 30M 的 log 文件并删除
   ```bash
   find /var/logs -name '*.log' -mtime +7 -size +30M -exec rm -f {} \;
   ```

Last Modified 2021-04-11
