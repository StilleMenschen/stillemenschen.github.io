# awk


## 简介

awk的基本功能是在文件中搜索包含某些模式的行（或其他文本单位）。当一行与其中一种模式匹配时，awk在该行上执行指定的操作。awk继续以这种方式处理输入行，直到到达输入文件的末尾。

```
awk [options] -f progfile [--] file ...
awk [options] [--] 'program' file ...
```

awk中的程序与大多数其他语言中的程序不同，因为awk程序是数据驱动的（即，您描述要使用的数据，然后在找到数据时要执行的操作）。其他大多数语言都是程序性的。您必须详细描述程序应采取的每个步骤。使用过程语言时，通常很难清楚地描述程序将要处理的数据。因此，awk程序通常很容易读取和编写。

当您运行awk时，可以指定一个awk程序来告诉awk该怎么做。该程序由一系列规则组成（它可能还包含函数定义，这是我们现在将忽略的高级功能；请参阅用户定义函数一节）。每个规则指定一个要搜索的模式，并在找到该模式时执行一个动作。

从句法上讲，规则由一个模式和一个动作组成。该动作用大括号括起来，以将其与模式分开。换行符通常是分开的规则。因此，awk程序如下所示：

```awk
# This program prints a nice, friendly message.  It helps
# keep novice users from being afraid of the computer.
pattern { action }
pattern { action }
...
```

引号问题

```bash
awk 'BEGIN { print "Don\47t Panic!" }' # \47表示单引号
awk "BEGIN { print \"Don't Panic!\" }" # 转义引号
```

## 参数

参数 | 说明
:--- | :---
-f source-file, --file source-file     | 指定awk脚本文件
-F fs, --field-separator fs            | 自定义分隔符`fs`（默认以空格作为分隔符）
-v var=val, --assign var=val           | 自定义变量`key=value`形式
-d[file], --dump-variables[=file]      | 将全局变量，变量的类型和最终值的排序列表打印到文件中。如果没有提供文件，则将此列表打印到当前目录中名为`awkvars.out`的文件中。如果提供了文件，则`-d`和文件之间不允许有空格。
-e program-text, --source program-text | 在程序文本中提供程序源代码
-E file, --exec file                   | 与`-f`相似，从文件中读取awk程序文本。 与`-f`有两个区别：<br> 此选项终止选项处理。命令行上的其他任何内容都直接传递给awk程序<br> 不允许使用`var=value`形式的命令行变量分配
-h, --help                             | 输出使用帮助信息并退出
-p[file], --profile[=file]             | 启用对awk程序的性能分析。表示`--no-optimize`。默认情况下，配置文件是在名为`awkprof.out`的文件中创建的。可选的file参数使您可以为配置文件指定其他文件名。如果提供了文件，则`-p`和文件之间不允许有空格。该配置文件在左边距中包含程序中每个语句的执行计数，以及每个函数的函数调用计数。
-S, --sandbox                          | 启用沙盒，禁用`system()`函数，使用`getline`输入重定向，使用`print`和`printf`输出重定向，以及动态扩展。另外，禁止在gawk开始运行时将不存在的文件名添加到`ARGV`。当您要从可疑来源运行awk脚本并且需要确保脚本无法访问系统（指定的输入数据文件除外）时，此功能特别有用
-V, --version                          | 打印版本信息并退出
--                                     | 标记所有选项的结尾。跟随`-`的所有命令行参数都放在ARGV中，即使它们以减号开头

> 使用`-d`选项列出所有全局变量是在程序中查找错误的好方法。如果您的大型程序具有很多功能，并且还希望确保您的函数不会无意中使用本应是局部变量的全局变量，那么您也可以使用此选项。（使用i，j等简单变量名称时，这是一个特别容易犯的错误）

## 搜索语法

语法 | 说明
:--- | :---
@include        | 引用其它外部脚本文件，如`@include "/usr/awklib/network"`
/regexp/        | 正则表达式搜索
exp ~ /regexp/  | 正则表达式搜索指定列，如`$2 ~ /a/`表示搜索以指定分隔符分隔的第二列中包含有小写字母a的文本
exp !~ /regexp/ | 正则表达式搜索不匹配的列，如`$2 !~ /a/`表示搜索以指定分隔符分隔的第二列中不包含有小写字母a的文本
$1 == "aa"      | 每行的第一个按分隔符分隔的字段完全等于`aa`比较符可以为`==`、`!=`，支持预定义变量
FNR == 3        | 文件的第3行，比较符可以为`==`、`<`、`>`、`<=`、`>=`、`!=`，支持预定义变量

## 转义字符

转义 | 说明
:--- | :---
`\\`   | 反斜杠
`\a`   | 警报字符，Ctrl-g，ASCII码`7`（BEL），（这通常会发出某种可听见的声音）
`\b`   | 退格键, Ctrl-h, ASCII码`8` (BS).
`\f`   | 换页, Ctrl-l, ASCII码`12` (FF).
`\n`   | 新行, Ctrl-j, ASCII码`10` (LF).
`\r`   | 回车, Ctrl-m, ASCII码`13` (CR).
`\t`   | 水平`TAB`, Ctrl-i, ASCII码`9` (HT).
`\v`   | 垂直`TAB`, Ctrl-k, ASCII码`11` (VT).
`\nnn` | 八进制字符，由1到3位的0到7数字组成，例如ASCII中的`ESC`（escape）字符表示为`\033`
`\xhh` | 十六进制字符，由1到2位的0到9和a到f（或A到F）组成，例如数字100表示为`\x64`（POSIX中的awk不允许使用`\x`转义）
`\/`   | 斜杠
`\"`   | 双引号

## 预定义变量

变量 | 说明
:--- | :---
`FS`       | 输入行的字段分隔符
`RS`       | 输入行分隔符
`RT`       | 与输入行分隔符`RS`表示的文本匹配的输入文本，每次读取记录时设置
`OFS`      | 输出行的字段分隔符
`ORS`      | 输出行分隔符
`ARGV`     | 参数数组，第一个为awk本身，索引为0到`ARGC`-1
`ARGC`     | 参数数量
`ARGIND`   | 正在处理的参数索引位置，从1开始
`ENVIRON`  | 环境变量数组，读取当前操作系统的环境变量，如`ENVIRON["JAVA_HOME"]`
`FILENAME` | 当前正在处理的文件名
`FNR`      | 当前处理文件的行号
`NF`       | 当前处理行以指定分隔符分隔的字段数量，可以使用`$NF`表示最后一个字段
`NR`       | 行号，从awk开始执行时自动累加
`PROCINFO` | 该数组的元素提供对有关正在运行的awk程序的信息的访问。<br>部分变量`PROCINFO["egid"]`、`PROCINFO["euid"]`、`PROCINFO["gid"]`、`PROCINFO["pgrpid"]`、`PROCINFO["pid"]`、`PROCINFO["ppid"]`、`PROCINFO["uid"]`、`PROCINFO["version"];`
`RLENGTH`  | 由`match()`函数匹配的子字符串的长度，RLENGTH是通过调用`match()`函数来设置的。它的值是匹配字符串的长度，如果找不到匹配项，则为-1
`RSTART`  | 与`match()`函数匹配的子字符串的字符的起始索引， 通过调用`match()`函数来设置`RSTART`，它的值是匹配的子字符串开始的字符串位置，如果找不到匹配项，则为0
`SYMTAB ` | 一个数组，其索引是程序中所有已定义的全局变量和数组的名称。SYMTAB使awk程序员可以看到gawk的符号表。它是在gawk解析程序时构建的，并在程序开始运行之前完成

## 变量

## 内置函数

Last Modified 2021-03-21