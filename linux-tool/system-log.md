# system log

## 日志路径

大部分默认在`/var/log`中

可以使用`less`、`cat`、`head`、`tail`、`grep`等命令查看和搜索

## 日志程序

```bash
systemctl status rsyslog
```

## 日志配置

配置文件在`/etc/rsyslog.conf`和目录`/etc/rsyslog.d`中

### 规则-日志设施

- `auth(security), authpriv`: 授权和安全相关的消息
- `kern`: 来自 Linux 内核的消息
- `mail`: 由 mail 子系统产生的消息
- `cron`: cron 守护进程相关的信息
- `daemon`: 守护进程产生的信息
- `news`: 网络消息子系统
- `lpr`: 打印相关的日志信息
- `user`: 用户进程相关的信息
- `local0 to local7`: 保留，本地使用

### 规则-日志级别有(升序)

- `debug`: 包含详细的开发情报的信息，通常只在调试一个程序时使用。
- `info`: 情报信息，正常的系统消息，比如骚扰报告，带宽数据等，不需要处理。
- `notice`: 不是错误情况，也不需要立即处理。
- `warning`: 警告信息，不是错误，比如系统磁盘使用了 85%等。
- `err`: 错误，不是非常紧急，在一定时间内修复即可。
- `crit`: 重要情况，如硬盘错误，备用连接丢失。
- `alert`: 应该被立即改正的问题，如系统数据库被破坏，ISP 连接丢失。
- `emerg`: 紧急情况，需要立即通知技术人员。

### 规则-日志设施的配置

- `.` 代表比后面还要高的消息等级都会记录下来
- `.=` 代表只有后面的这个消息等级会被记录下来
- `.!` 代表除了后面的这个消息等级其他的都会被记录下来

## 滚动日志配置

配置文件在`/etc/logrotate.conf`和目录`/etc/logrotate.d`中

### 指令

- `compress` 指定日志需要压缩
- `compresscmd` 指定日志压缩的命令，默认是`gzip`
- `uncompresscmd` 指定解压缩日志的命令，默认是`gunzip`
- `compressext` 压缩日志文件的拓展名，默认遵循压缩程序的配置
- `compressoptions` 传递给日志压缩程序的命令行参数，默认使用`gzip`压缩式传递`-6`，即牺牲速度换取高压缩率
- `copy` 复制原始日志文件但不修改
- `copytruncate` 复制原始日志文件后截断原文件，可能会在执行操作过程中出现丢失一部分日志记录的情况
- `create [mode owner group], create [owner group]` 指定创建日志文件的权限和归属用户及用户组，权限为八进制的 4 位数字配置，参考`chmod`命令，可通过`nocreate`禁用此操作
- `createolddir [mode owner group]` 指定存放旧日志的目录，如果不存在则会被创建，可通过`nocreateolddir`禁用此操作
- `daily` 指定每天滚动日志
- `dateext` 在滚动的旧日志文件追加日期，如`YYYYMMDD`，可通过`dateformat`和`dateyesterday`拓展
- `dateformat` 使用类似于`strftime`函数的符号指定`dateext`的扩展名。仅允许使用`%Y` `%m` `%d` `%H` `%M` `%S` `%V` 和 `%s`说明符。默认值为 `-%Y%m%d`，每小时除外，它使用`-%Y%m%d%H`作为默认值。请注意，将日志名称与扩展名分开的字符也是日期格式字符串的一部分。系统时钟必须设置为`2001年9月9日`之后才能使`%s`正常工作。请注意，此格式生成的日期戳必须按词法排序（首先是年份，然后是月份，然后是日期。例如`2001/12/01`是可以的，但`01/12/2001`不行，因为`01/11/2002`会排序较低，而较晚）。这是因为当使用旋转选项时，`logrotate`会对所有旋转的文件名进行排序，以找出哪些日志文件较旧并且应该被删除。
- `dateyesterday` 使用昨天的日期来创建`dateext`拓展名
- `datehourago` 使用小时前而不是当前日期来创建`dateext`扩展，以便旋转日志文件的名称中有一个小时，与其中的时间戳相同。每小时轮换有用
- `delaycompress` 推迟到下一个循环周期再做压缩，仅与`compress`结合使用有效，当无法告诉某些程序关闭其日志文件时可以使用
- `extension [ext]` 扩展名为`ext`的日志文件可以在轮换后保留。如果使用压缩，压缩扩展名（通常为 .gz）出现在`ext`之后。例如，有一个名为`mylog.foo`的日志文件，并希望将其轮换为`mylog.1.foo.gz`而不是`mylog.foo.1.gz`
- `hourly` 日志文件每小时轮换一次。请注意，通常`logrotate`被配置为每天由`cron`运行。您必须更改此配置并每小时运行`logrotate`才能真正每小时轮换日志
- `addextension [ext]` 日志文件在轮换后被赋予最终的扩展名`ext`。如果原始文件已经以`ext`结尾，则不会复制扩展名，而只是将其移至末尾，即文件名和文件名扩展名都将旋转为`文件名.1ext`。如果使用压缩，压缩扩展名（通常为 .gz）出现在`ext`之后
- `ifempty` 轮换日志文件，即使它的大小是空的，覆盖`notifempty`选项
- `include [file | directory]` 读取外部的配置文件或配置文件所在目录
- `mail [address]` 发送日志文件到指定的邮箱
- `mailfirst` 发送最近刚刚轮换的日志文件到邮箱
- `maillast` 发送最旧的轮换日志文件到邮箱
- `minage [count]` 不轮换小于`<count>`天的日志
- `maxage [count]` 删除早于`<count>`天的轮换日志
- `maxsize [size]` 即使在额外指定的时间间隔（每天、每周、每月或每年）之前，日志文件的大小超过`size`字节时也会轮换。相关尺寸选项类似，只是它是互斥的。包含时间间隔选项，它会导致日志文件在不考虑上次轮换时间的情况下轮换。使用`maxsize`时，会同时考虑日志文件的大小和时间戳
- `minsize [size]` 当日志文件大于`size`字节时，但不会在额外指定的时间间隔（每天、每周、每月或每年）之前轮换。`related size`选项类似，只是它是相互的。与时间间隔选项互斥，它会导致日志文件在不考虑上次轮换时间的情况下轮换。使用`minsize`时，会同时考虑日志文件的大小和时间戳
- `missingok` 如果日志文件丢失则继续而不发出错误消息，另见`nomissingok`
- `monthly` 每月轮换日志文件（通常是每月的第一天）
- `nocompress` 不压缩旧日志
- `nocopy` 不复制原始日志文件
- `nocopytruncate` 复制原始日志文件后不截断
- `nocreate` 不创建新的日志文件
- `nocreateolddir` 旧日志文件目录不存在时，`logrotate`不会创建它
- `nodelaycompress` 不会将先前日志文件的压缩推迟到下一个循环周期（这会覆盖`delaycompress`选项）
- `nodateext` 不会存档带有日期扩展名的旧版本日志文件（这会覆盖`dateext`选项）
- `nomail` 不会将旧的日志文件邮寄到任何地址
- `nomissingok` 如果日志文件不存在，则发出错误，这是默认配置
- `noolddir` 日志在它们通常驻留的目录中轮换（这会覆盖`olddir`选项）
- `nosharedscripts` 为每个旋转的日志文件运行`prerotate`和`postrotate`脚本（这是默认设置，并覆盖`sharedscripts`选项）。日志文件的绝对路径作为第一个参数传递给脚本。如果脚本因错误退出，则不会对受影响的日志执行其余操作
- `noshred` 删除旧日志文件时不要使用`shred`，另见`shred`
- `notifempty` 如果日志为空，则不要旋转日志（这会覆盖`ifempty`选项）
- `olddir [directory]` 日志被移动到目录中进行轮换。该目录必须与正在轮换的日志文件位于同一物理设备上，除非使用了复制、复制截断或重命名复制选项。除非指定了绝对路径名，否则假定该目录是相对于保存日志文件的目录的。当使用此选项时，所有旧版本的日志最终都会出现在目录中。此选项可能会被`noolddir`选项覆盖
- `postrotate/endscript` 在`postrotate`和`endscript`之间的行（两者都必须单独出现在行中）在日志文件轮换后执行（使用`/bin/sh`）。这些指令可能只出现在日志文件定义中。通常，日志文件的绝对路径作为第一个参数传递给脚本。如果指定了`sharedscripts`，则将整个模式传递给脚本
- `prerotate/endscript` 在`prerotate`和`endscript`之间的行（两者都必须单独出现在行中）在日志文件轮换之前执行（使用`/bin/sh`），并且仅当日志实际轮换时才执行。这些指令可能只出现在日志文件定义中。通常，日志文件的绝对路径作为第一个参数传递给脚本。如果指定了`sharedscripts`，则将整个模式传递给脚本
- `firstaction/endscript` 在`firstaction`和`endscript`之间的行（两者都必须单独出现在行中）在轮换所有匹配通配符模式的日志文件之前执行一次（使用`/bin/sh`），在运行`prerotate`脚本之前，并且仅当至少有一个日志实际上将被旋转。这些指令可能只出现在日志文件定义中。整个模式作为第一个参数传递给脚本。如果脚本因错误而退出，则不会进行进一步的处理
- `lastaction/endscript` 在`lastaction`和`endscript`之间的行（两者都必须单独出现在行中）在所有匹配通配符模式的日志文件轮换后执行一次（使用`/bin/sh`），在运行`postrotate`脚本之后，并且只有至少一个日志被轮换。这些指令可能只出现在日志文件定义中。整个模式作为第一个参数传递给脚本。如果脚本因错误而退出，则只会显示一条错误消息（因为这是最后一个操作）
- `preremove/endscript` 在`preremove`和`endscript`之间的行（两者都必须单独出现在行中）在删除日志文件之前执行一次（使用`/bin/sh`）。`logrotate`将传递即将被删除的文件的名称
- `rotate [count]` 日志文件在被删除或邮寄到邮件指令中指定的地址之前会轮换`count`次。如果计数为 0，旧版本将被删除而不是轮换。默认为 0
- `renamecopy` 通过向日志文件添加`.tmp`扩展名，将日志文件重命名为同一目录中的临时文件名。之后，运行`postrotate`脚本并将日志文件从临时文件名复制到最终文件名。这允许使用`olddir`指令将轮换日志文件存储在不同的设备上。最后，临时文件名被删除
- `size [size]` 只有当日志文件增长到大于`size`字节时，它们才会被轮换。如果大小后跟 k，则假定大小以千字节为单位。如果使用 M，则大小以兆字节为单位，如果使用 G，则大小以千兆字节为单位。所以大小`100`、大小`100k`、大小`100M`和大小`100G`都是有效的
- `sharedscripts` 通常，`prerotate`和`postrotate`脚本会为每个被轮换的日志运行，并且日志文件的绝对路径作为第一个参数传递给脚本。这意味着单个脚本可能会针对匹配多个文件的日志文件条目运行多次（例如`/var/log/news/*`示例）。如果指定了`sharedscripts`，则脚本只运行一次，无论有多少日志匹配通配符模式，整个模式都会传递给它们。但是，如果模式中的日志都不需要轮换，则根本不会运行脚本。如果脚本因错误退出，则不会对任何日志执行其余操作。此选项覆盖`nosharedscripts`选项并隐含创建选项
- `shred` 使用`shred -u`而不是`unlink()`删除日志文件。这应该确保日志在计划删除后不可读；这是默认关闭的。另见`noshred`
- `shredcycles [count]` 要求`GNU shred`在删除前覆盖日志文件`count`次。如果没有此选项，将使用`shred`的默认值
- `start [count]` 这是用作旋转基础的数字。 比如您指定`0`，则将创建带有`.0`扩展名的日志，因为它们是从原始日志文件轮换而来的。如果指定`9`，将使用`.9`创建日志文件，跳过`0-8`。文件仍将按`rotate`指令指定的次数旋转
- `su [user] [group]` 轮换在此用户和组下设置的日志文件，而不是使用默认用户/组（通常是`root`）。`user`指定用于轮换的用户名，`group`指定用于轮换的组。如果您在此处指定的用户/组没有足够的权限来创建具有您在创建指令中指定的所有权的文件，则会导致错误
- ` weekly [weekday]` 日志文件在每个工作日轮换一次，或者如果日期自上次轮换后至少提前`7`天（同时忽略确切时间）。工作日解释如下：0 表示星期天，1 表示星期一，...，6 表示星期六；特殊值`7`表示每 7 天一次，与工作日无关。如果省略工作日参数，则默认为 0
- `yearly` 如果当前年份与上次轮换不同，则日志文件将轮换

## 常见日志

- /var/log/boot.log: System Boot log (boot log 存储所有与开机操作相关的信息)
- /var/log/auth.log: Auth logs（认证日志存储所有的认证日志，包括成功和失败的尝试）
- /var/log/debug: 调试日志（调试日志存储与调试相关的详细消息，对于排除特定系统操作的故障很有用）
- /var/log/daemon.log：守护进程日志（守护进程日志包含与运行 Linux 操作相关的事件信息）
- /var/log/maillog: 邮件服务器日志（邮件日志存储与邮件服务器和归档邮件相关的信息）
- /var/log/kern.log：内核日志（内核日志存储来自 Ubuntu Linux 内核的信息）
- /var/log/yum.log: Yum 命令日志

> 实际会有哪些日志还是需要看配置文件才能知道

## 更多文档参考

- https://www.rsyslog.com

Last Modified 2022-11-25
