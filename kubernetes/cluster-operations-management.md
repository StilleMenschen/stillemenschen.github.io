# 集群运维

## 集群规模

你需要多大的集群？在使用自托管的 Kubernetes 集群，或任何托管的服务时，集群的持续成本直接取决于其节点的数量和大小。如果集群的容量过小，则你的工作负载将无法正常运行，或者在流量过大时崩溃；如果集群的容量过大，那就是浪费钱。适当地调整集群的大小和规模非常重要

## 容量规划

初步估算所需容量的一种方法是，想一想运行同一款应用程序需要多少传统 服务器。例如，如果当前体系结构在 10 个云实例上运行，则为了运行相同的工作负载，Kubernetes 集群所需的节点数不会超过 10 个，再加上 1 个冗余节点。事实上，你可能不需要那么多，因为 Kubernetes 可以在多个机器上均匀分布工作负载，因此可以实现比传统服务器更高的利用率。但是，可能需要一些时间和实践经验才能将集群调整到最佳容量。

在第一次设置集群时，你可能需要在集群上进行尝试和实验，弄清楚如何运行应用程序。因此，在对所需容量有所了解之前，不需要烧钱购买大型集群。最小的 Kubernetes 集群就是单节点集群。可以通过最小集群尝试 Kubernetes，并运行少量用于开发的工作负载。然而，单节点集群无法抵抗节点硬件、Kubernetes API 服务器或 kubelet（负责在每每个节点上运行工作负载的代理守护程序）的故障。

一个健壮的 Kubernetes 集群至少需要 3 个主节点。1 个主节点不够健壮，而 2 个节点无法在谁是主节点的问题上达成一致，因此需要 3 个主节点。

虽然你可以在这么小的 Kubernetes 集群上做一些有意义的工作，但不建议这样做。更妥当的做法是添加一些工作节点，确保你自己的工作负载不会与 Kubernetes 控制平面争夺资源。

如果集群控制平面具备高可用性，那么你可以只使用一个工作节点，但是以防万一节点发生故障，至少应该准备两个工作节点，并允许 Kubernetes 至少为每个 Pod 运行两个副本。节点越多越好，尤其是因为 Kubernetes 调度器无法总是确保工作负载非常均匀地分布在各个可用节点之上

Kubernetes 集群至少需要三个主节点才能具备高可用性，而且你可能还需要更多的主节点来处理大型集群的工作。最少需要两个工作节点，工作负载才能承受单个工作结点出错，而三个工作节点则更好。

## 联合集群

如果你的工作负载需要非常多的资源，或者需要运维超大规模的集群，那么这些限制可能会成为现实问题。在这种情况下，你可以运行多个 Kubernetes 集群，并在必要时联合所有的集群，这样工作负载就可以跨集群复制了。

联合能够保持两个或多个集群同步，运行完全相同的工作负载。你可以利用联合集群，通过多个云提供商的 Kubernetes 集群增强健壮性，或通过位于不同的地理位置的集群来减少用户的延迟。即使某个集群发生故障，一组联合集群也可以继续运行。

大多数 Kubernetes 用户可能并不需要关心联合，而且实际上，大多数大规模用户都可以使用多个无联合集群（每个集群有几百到几千个节点）来处理工作负载。

除非像上一节说的那样你需要运维大规模的集群，否则一般情况下一两个集群就够用了，例如一个用于生产，另一个用于预发布和测试。

为了方便又轻松地管理资源，你可以使用命名空间将集群划分为逻辑分区。除了少数例外情况之外，通常多个集群带来的管理开销都得不偿失。

在某些特定情况下，例如为了安全性和遵从法规，你可能需要某个集群中的服务与另一个集群绝对隔离（例如，在处理需要保护的健康信息时，或出于法律原因数据不能从某个地理位置传输到其他地方时）。只有在这些情况下，你才需要创建单独的集群。而大多数 Kubernetes 用户都不会遇到这种问题。除非一组工作负载或团队确实需要与另一组完全隔离，否则一个生
产集群和一个预发布集群就足够了。如果只是为了便于管理想对集群进行分区，那么请使用命名空间。

某个节点的容量越大，它可以完成的工作就越多。节点的容量主要用 CPU 内核数（虚拟或其他）以及可用的内存量表示，其次是磁盘空间。但是，运行 10 个非常大的节点，还是运行 100 个非常小的节点，哪种方式更好呢？Kubernetes 集群的节点大小没有统一的正确答案。这取决于你的云提供商或硬件提供商，以及工作负载的情况。

不同大小的实例的单位容量平均成本可能会影响你决定节点大小的方式。例如，某些云提供商可能会提供大型实例的折扣，因此，如果你的工作负载是计算密集型的，那么与大量的小型节点相比，在少数几个规模非常大的节点上运行可能会更便宜。

集群所需的节点数也会影响节点大小的选择。Kubernetes 支持 Pod 副本和高可用，需要将其分散到不同的节点上，但节点的备用容量越多也会造成资金浪费。要按需来调整节点实例的大小，如果服务不多，但是要保证可用性，可以使用多个小节点；如果对可用性要求不是很高，但服务非常多，可以选择规模较大的节点。

> 某些服务可能需要特殊的资源如 GPU、大量的内存和 CPU、Windows 系统等，可以利用节点亲和性配置使其调度到合适的节点上

## 弹性伸缩

Last Modified 2023-06-08
