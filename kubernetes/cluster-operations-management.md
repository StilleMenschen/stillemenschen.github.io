# 集群运维

## 集群规模

你需要多大的集群？在使用自托管的 Kubernetes 集群，或任何托管的服务时，集群的持续成本直接取决于其节点的数量和大小。如果集群的容量过小，则你的工作负载将无法正常运行，或者在流量过大时崩溃；如果集群的容量过大，那就是浪费钱。适当地调整集群的大小和规模非常重要

## 容量规划

初步估算所需容量的一种方法是，想一想运行同一款应用程序需要多少传统 服务器。例如，如果当前体系结构在 10 个云实例上运行，则为了运行相同的工作负载，Kubernetes 集群所需的节点数不会超过 10 个，再加上 1 个冗余节点。事实上，你可能不需要那么多，因为 Kubernetes 可以在多个机器上均匀分布工作负载，因此可以实现比传统服务器更高的利用率。但是，可能需要一些时间和实践经验才能将集群调整到最佳容量。

在第一次设置集群时，你可能需要在集群上进行尝试和实验，弄清楚如何运行应用程序。因此，在对所需容量有所了解之前，不需要烧钱购买大型集群。最小的 Kubernetes 集群就是单节点集群。可以通过最小集群尝试 Kubernetes，并运行少量用于开发的工作负载。然而，单节点集群无法抵抗节点硬件、Kubernetes API 服务器或 kubelet（负责在每每个节点上运行工作负载的代理守护程序）的故障。

一个健壮的 Kubernetes 集群至少需要 3 个主节点。1 个主节点不够健壮，而 2 个节点无法在谁是主节点的问题上达成一致，因此需要 3 个主节点。

虽然你可以在这么小的 Kubernetes 集群上做一些有意义的工作，但不建议这样做。更妥当的做法是添加一些工作节点，确保你自己的工作负载不会与 Kubernetes 控制平面争夺资源。

如果集群控制平面具备高可用性，那么你可以只使用一个工作节点，但是以防万一节点发生故障，至少应该准备两个工作节点，并允许 Kubernetes 至少为每个 Pod 运行两个副本。节点越多越好，尤其是因为 Kubernetes 调度器无法总是确保工作负载非常均匀地分布在各个可用节点之上

Kubernetes 集群至少需要三个主节点才能具备高可用性，而且你可能还需要更多的主节点来处理大型集群的工作。最少需要两个工作节点，工作负载才能承受单个工作结点出错，而三个工作节点则更好。

## 联合集群

如果你的工作负载需要非常多的资源，或者需要运维超大规模的集群，那么这些限制可能会成为现实问题。在这种情况下，你可以运行多个 Kubernetes 集群，并在必要时联合所有的集群，这样工作负载就可以跨集群复制了。

联合能够保持两个或多个集群同步，运行完全相同的工作负载。你可以利用联合集群，通过多个云提供商的 Kubernetes 集群增强健壮性，或通过位于不同的地理位置的集群来减少用户的延迟。即使某个集群发生故障，一组联合集群也可以继续运行。

大多数 Kubernetes 用户可能并不需要关心联合，而且实际上，大多数大规模用户都可以使用多个无联合集群（每个集群有几百到几千个节点）来处理工作负载。

除非像上一节说的那样你需要运维大规模的集群，否则一般情况下一两个集群就够用了，例如一个用于生产，另一个用于预发布和测试。

为了方便又轻松地管理资源，你可以使用命名空间将集群划分为逻辑分区。除了少数例外情况之外，通常多个集群带来的管理开销都得不偿失。

在某些特定情况下，例如为了安全性和遵从法规，你可能需要某个集群中的服务与另一个集群绝对隔离（例如，在处理需要保护的健康信息时，或出于法律原因数据不能从某个地理位置传输到其他地方时）。只有在这些情况下，你才需要创建单独的集群。而大多数 Kubernetes 用户都不会遇到这种问题。除非一组工作负载或团队确实需要与另一组完全隔离，否则一个生
产集群和一个预发布集群就足够了。如果只是为了便于管理想对集群进行分区，那么请使用命名空间。

某个节点的容量越大，它可以完成的工作就越多。节点的容量主要用 CPU 内核数（虚拟或其他）以及可用的内存量表示，其次是磁盘空间。但是，运行 10 个非常大的节点，还是运行 100 个非常小的节点，哪种方式更好呢？Kubernetes 集群的节点大小没有统一的正确答案。这取决于你的云提供商或硬件提供商，以及工作负载的情况。

不同大小的实例的单位容量平均成本可能会影响你决定节点大小的方式。例如，某些云提供商可能会提供大型实例的折扣，因此，如果你的工作负载是计算密集型的，那么与大量的小型节点相比，在少数几个规模非常大的节点上运行可能会更便宜。

集群所需的节点数也会影响节点大小的选择。Kubernetes 支持 Pod 副本和高可用，需要将其分散到不同的节点上，但节点的备用容量越多也会造成资金浪费。要按需来调整节点实例的大小，如果服务不多，但是要保证可用性，可以使用多个小节点；如果对可用性要求不是很高，但服务非常多，可以选择规模较大的节点。

> 某些服务可能需要特殊的资源如 GPU、大量的内存和 CPU、Windows 系统等，可以利用节点亲和性配置使其调度到合适的节点上

## 缩小集群

原则上，缩小 Kubernetes 集群的规模不会有任何问题。你只需告诉 Kubernetes 排空你想要删除的节点，就可以逐步关闭所有正在运行的 Poo，或将它们移至其他节点上。

大多数集群管理工具会自动帮你排空节点，或者你也可以使用`kubectl drain`命令。前提是集群的其余部分有足够的备用容量，可以重新调度这些不幸的 Pod，在节点被排空后，就可以终止它们了。

为了避免某个服务的 Pod 副本数量减少过多，可以通过 Pod 中断预算指定最小可用 Pod 数，或指定在任意时刻最大不可用 Pod 数。如果排空节点会导致 Kubernetes 超出这些限制，则排空操作就会粗塞，直到你更改约束，或释放集群中的一些资源。

排空操作可以让 Pod 优雅地关闭，清理并保存所有必要的状态。对于大多数应用程序而言，排空比直接关闭节点（会立即终止 Pod）更可取。

## 自动伸缩

随着业务需求的变化，集群的规模可能需要扩大或缩小

如果需要动态地调整集群规模，可以考虑使用云提供商的各种工具，如 AWS 的自动伸缩组（AWS Autoscaling Groups，ASG）。Kubernetes 有一个名为 Cluster Autoscaler 的插件，kops 等集群管理工具可以利用这个插件来激活云自动伸缩。

你需要花费一些时间，进行一些试验，才能正确地设置自动伸缩，并且对于许多用户而言，这根本没有必要。大多数 Kubernetes 集群都是从小规模开始，并随着资源使用量的增加通过不断添加节点而逐渐增长。但是，对于大规模用户或需求变化很大的应用程序来说，集群自动伸缩是非常实用的功能。

不要因为集群有自动伸缩的功能就启用。除非工作负载或需求变化很大，否则不太需要这个功能。应当手动管理集群的规模，至少等运行一段时间，掌握规模需求随着时间的变化规律之后再考虑自动伸缩。

## 一致性检查

Kubernetes 的灵活性意味着你可以采用各种方法来建立 Kubernetes 集群，而这就可能产生一个问题。如果将 Kubernetes 作为通用的平台，那么同一个工作负载应该能够在任何 Kubernetes 集群上运行，而且能够按照预期的方式工作。这意味着任何 Kubernetes 集群都必须具备相同的 API 调用和 Kubernetes 对象，它们必须具有相同的行为，它们的工作方式必须与宣称的一样等。

好消息是，Kubernetes 本身包含一个测试套件，可验证某个 Kubernetes 集群是否符合要求。也就是说，满足某个 Kubernetes 版本的一系列核心要求。这些一致性测试对于 Kubernetes 管理员非常有用。

如果你的集群没有通过这些测试，则说明你的设置存在问题，需要解决。如果通过了，则表示你的集群符合标准，你可以相信为 Kubernetes 设计的应用程序都可以在你的集群上运行，而且你在集群上构建的东西也可以在其他地方使用。

云原生计算基金会（Cloud Native Computing Foundation， CNCF）是 Kubernetes 项目和商标的官方所有者，该组织还提供 Kubernetes 相关产品、工程师以及提供商的各种认证。如 Kubernetes 管理员（CKA）、Kubernetes 认证服务提供商（KCSP）等。

如果你自己管理集群，或者即使你使用托管服务，但想确认一下它的配置是否正确而且是最新的，则可以运行 Kubernetes 一致性测试来证明。标准的运行这些测试的工具是 Sonobuoy。请在集群首次建立后运行 Sonobuoy，以验证其是否符合标准且一切正常。之后要经常运行它，以确保没有一致性问题。

集群一致性是一个基准，任何生产集群都应该符合一致性标准，但是一致性测试并不能发现 Kubernetes 的配置和工作负载中可能存在的许多常见问题。

## 验证工具

### K8Guard

Target 开发的 K8Guard 工具可以检查 Kubernetes 集群的常见问题，并采取纠正措施或只向你发送通知。你可以根据集群的特定策略来配置这个工具（例如，如果任何容器镜像大于 1GiB，或入口规则允许从任何地方访问，则可以指定 K8Guard 向你发出警告）。

K8Guard 还可以导出指标供 Prometheus 等监控系统收集，例如有多少部署违反策略，以及 Kubernetes API 响应的性能等。这可以帮助你尽早发现并解决问题。

你可以在集群上一直运行 K8Guard，以便出现任何违规现象时向你发出警告。

### Copper

Copper 是一种工具，可用于在部署 Kubernetes 清单之前对清单进行检查，并标记出常见的问题，或执行自定义的策略。它支持一种领域特定语言（Domain-Specific Language， DSL） ，用于表示验证规则和策略。

例如，以下是用 Copper 语言表达的规则，可以防止任何容器使用 latest 标签：

```
rule NoLatest ensure {
    fetch("$.spec.template.spec.containers..image")
    .as(:image)
    .pick(:tag)
    .contains("latest") == false
}
```

如果针对包含 latest 容器镜像规范的 Kubernetes 清单运行 copper check 命令，则会有对应的错误消息输出。还有一个相关的工具名为 kubeval，可以根据 Kubernetes API 规范验证清单文件。

### kube-bench

kube-bench 是一种工具，可以根据互联网安全中心（Center for InternetSecurity，CIS）制定的一组基准审核 Kubernetes 集群。实际上，它可以验证你的集群是否根据最佳安全实践进行了设置。你可以配置 kube-bench 运行的测试，甚至可以通过 YAML 文档添加自己的基准（尽管可能不需要这样做）。

## 审计日志

假设你发现了某个集群的问题，例如某个不认识的 Pod，你想知道它的来源。怎样才能找出谁在集群上做了些什么呢？ Kubernetes 审计日志可以告诉你。启用审计日志记录后，集群 API 的所有请求都会被记录，且带有时间戳，能够告诉你谁发送了这些请求（哪个服务账号），以及请求的详细信息（例如查询的资源以及响应是什么）。

审计事件可以发送到中央日志记录系统，你可以像处理其他日志数据一样，过滤日志并发出警告。优秀的托管服务（例如 Google Kubernetes Engine）默认都包括审计日志记录；如果没有的话，则可能需要自行修改集群配置才能启用。

## 混乱测试

验证高可用的有效方法就是直接干掉一个或多个集群节点，然后看看结果会怎样。这种方法对于 Kubernetes Pod 和应用程序的高可用性同样适用。可以随机选择一个 Pod 并终止它，确保 Kubernetes 会重新启动它，并且不会影响错误率。

要手动操作是非常耗时的，而且一不小心还可能会消耗掉对应用程序至关重要的资源。为了确保测试正确执行，可选择一些工具来实现自动化。

### Chaoskube

chaoskube 会随机干掉集群中的 Pod。在默认情况下，它会以演习的模式进行，只显示即将执行的操作，而不会实际终止任何东西。

你可以通过配置 chaoskube，根据标签、注释和命名空间包含或排除某些 Pod，或避免某些时间段或日期（例如，不要在圣诞节前夕干掉任何东西）。但是在默认情况下，它可能会干掉任何一个命名空间中的任何一个 Pod，包括 Kubernetes 系统的 Pod，甚至是 chaoskube 本身。

在你满意 chaoskube 过滤器的配置后，就可以关掉演习模式，让它正常工作了。chaoskube 的安装和设置很简单，是混乱工程的理想工具。

### kube-monkey

kube-monkey 会在预设时间（默认是工作日的上午 8 点）运行，并制定日程计划，确定在其余时间内（默认是上午 10 点至下午 4 点）哪些部署会成为破坏的目标。与其他工具不同，kube-monkey 采用了选择加入的方式，即只有通过注释专门启用了 kube-monkey 的 Pod 才会成为破坏的对象。

这意味着你可以在特定的应用程序或服务的开发过程中加入 kube-monkey 测试，并根据服务设置不同级别的频率和攻击程度。例如，如下 Pod 注释将两次故障之间的平均时间（Mean Time Between Failures，即 MTBF）设置 2 天

```yaml
kube-monkey/mtbf: 2
```

你可以使用 kill-mode 注释指定干掉多少个部署的 Pod，也可以指定最大百分比。以下注释会干掉目标部署中最多 50% 的 Pod:

```yaml
kube-monkey/kill-mode: "random-max-percent"
kube-monkey/kill-value: 50
```

### PowerfulSeal

PowerfulSeal 是一款开源的 Kubernetes 混乱工程工具，它有两种工作模试：交互模式和自动模式。在交互式模式下，你可以探索集群并手动搞破坏，然后看看后果会怎样。它可以终止节点、命名空间、部署以及各个 Pod。

自动模式使用一组由你指定的策略：操作哪个资源、避开哪个资源、何时运行（例如，你可以指定仅在周一至周五的工作时间内运行）以及攻击程度为多高（例如干掉一定比例的匹配部署）。

PowerfulSeal 的策略文件非常灵活，可以方便你设置所有可能的混乱工程方案。

> 如果你的应用程序需要高可用性，那么请定期运行 chaoskube 之类的混乱测试工具，以确保节点发生意外或 Pod 出现故障时不会引发问题。但要提前向负责运维集群以及测试目标应用程序的人员说明情况。

Last Modified 2023-06-09
